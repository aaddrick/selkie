name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
        description: 'Release tag (e.g. v0.1.0)'

permissions:
  contents: write

jobs:
  # --- Build stage ---
  build-amd64:
    uses: ./.github/workflows/build.yml
    with:
      arch: amd64
      version: ${{ github.event_name == 'push' && github.ref_name || inputs.tag }}

  build-arm64:
    uses: ./.github/workflows/build.yml
    with:
      arch: arm64
      version: ${{ github.event_name == 'push' && github.ref_name || inputs.tag }}

  # --- Compute version ---
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Determine version
        id: version
        run: |
          TAG="${{ github.event_name == 'push' && github.ref_name || inputs.tag }}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

  # --- Package stage ---
  package-deb-amd64:
    needs: [prepare, build-amd64]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-amd64
          path: staging/
      - name: Build .deb
        run: ./packaging/build-deb.sh staging/ "$VERSION" amd64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-deb-amd64
          path: '*.deb'
          if-no-files-found: error

  package-deb-arm64:
    needs: [prepare, build-arm64]
    runs-on: ubuntu-22.04-arm
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-arm64
          path: staging/
      - name: Build .deb
        run: ./packaging/build-deb.sh staging/ "$VERSION" arm64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-deb-arm64
          path: '*.deb'
          if-no-files-found: error

  package-rpm-amd64:
    needs: [prepare, build-amd64]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-amd64
          path: staging/
      - name: Install rpmbuild
        run: sudo apt-get update && sudo apt-get install -y rpm
      - name: Build .rpm
        run: ./packaging/build-rpm.sh staging/ "$VERSION" amd64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-rpm-amd64
          path: '*.rpm'
          if-no-files-found: error

  package-rpm-arm64:
    needs: [prepare, build-arm64]
    runs-on: ubuntu-22.04-arm
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-arm64
          path: staging/
      - name: Install rpmbuild
        run: sudo apt-get update && sudo apt-get install -y rpm
      - name: Build .rpm
        run: ./packaging/build-rpm.sh staging/ "$VERSION" arm64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-rpm-arm64
          path: '*.rpm'
          if-no-files-found: error

  package-appimage-amd64:
    needs: [prepare, build-amd64]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-amd64
          path: staging/
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y libfuse2
      - name: Build AppImage
        run: ./packaging/build-appimage.sh staging/ "$VERSION" amd64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-appimage-amd64
          path: |
            *.AppImage
            *.zsync
          if-no-files-found: error

  package-appimage-arm64:
    needs: [prepare, build-arm64]
    runs-on: ubuntu-22.04-arm
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: selkie-staging-arm64
          path: staging/
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y libfuse2
      - name: Build AppImage
        run: ./packaging/build-appimage.sh staging/ "$VERSION" arm64
      - uses: actions/upload-artifact@v4
        with:
          name: selkie-appimage-arm64
          path: |
            *.AppImage
            *.zsync
          if-no-files-found: error

  # --- Release stage ---
  release:
    needs:
      - prepare
      - package-deb-amd64
      - package-deb-arm64
      - package-rpm-amd64
      - package-rpm-arm64
      - package-appimage-amd64
      - package-appimage-arm64
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.prepare.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      - name: Collect release files
        run: |
          mkdir release-files
          find artifacts/ -type f \( -name '*.deb' -o -name '*.rpm' -o -name '*.AppImage' -o -name '*.zsync' \) \
            -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Find previous tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${TAG}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            RANGE="$TAG"
            echo "First release — including all commits"
          else
            RANGE="${PREV_TAG}..${TAG}"
            echo "Generating notes for $RANGE"
          fi

          # Write commit log and stat summary to file (avoids shell variable size limits)
          git log "$RANGE" --pretty=format:'### Commit %h%n**%s**%n%n%b' --no-merges > changes-messages.txt
          git log "$RANGE" --stat --no-merges > changes-stat.txt
          git diff "${PREV_TAG:-$(git rev-list --max-parents=0 HEAD)}" "$TAG" --stat > changes-diff-stat.txt

          # Truncate diffs to fit API limits
          git log "$RANGE" --pretty=format:'--- %h: %s ---' --patch --no-color > changes-full.txt
          truncate -s '<150000' changes-full.txt

          # Build prompt as a file
          cat > prompt.txt <<'PROMPT_END'
          You are writing release notes for Selkie, a Zig-based GUI markdown viewer for Linux.
          Selkie is built with Zig and raylib, supports GitHub Flavored Markdown via cmark-gfm,
          renders Mermaid diagrams natively, and has theming support.

          Write release notes using EXACTLY this structure (keep all section headers, use "None." if empty):

          ## Highlights

          1-3 sentences summarizing the most important changes in this release.

          ## New Features

          - Bullet points describing user-visible new features
          - Focus on what users can now DO, not implementation details

          ## Improvements

          - Bullet points for enhancements to existing features
          - Performance improvements, UX improvements, etc.

          ## Bug Fixes

          - Bullet points for bugs that were fixed
          - Describe the symptom that was fixed, not the code change

          ## Infrastructure

          - Brief bullet points for CI/CD, packaging, build, or documentation changes
          - Keep this section short — users care less about this

          ## Contributors

          Thank any contributors whose commits appear in this release, EXCLUDING:
          - aaddrick (project maintainer — do not thank)
          - Claude / github-actions[bot] / any AI (do not thank)

          If there are no other contributors, omit this section entirely.
          Format: "Thanks to @username for their contribution!" with a brief note on what they did.

          ## Install

          **APT (Debian/Ubuntu):**
          ```bash
          curl -fsSL https://aaddrick.github.io/selkie/KEY.gpg | sudo gpg --dearmor -o /usr/share/keyrings/selkie.gpg
          echo "deb [signed-by=/usr/share/keyrings/selkie.gpg arch=amd64,arm64] https://aaddrick.github.io/selkie stable main" | sudo tee /etc/apt/sources.list.d/selkie.list
          sudo apt update && sudo apt install selkie
          ```

          **DNF (Fedora/RHEL):**
          ```bash
          sudo curl -fsSL https://aaddrick.github.io/selkie/rpm/selkie.repo -o /etc/yum.repos.d/selkie.repo
          sudo dnf install selkie
          ```

          **AUR:** `yay -S selkie`

          **AppImage / .deb / .rpm:** Download from the assets below.

          Rules:
          - Do NOT include a title heading (the release already has "Selkie vX.Y.Z")
          - Do NOT list individual files changed
          - Do NOT mention commit hashes
          - Keep total length under 500 words
          - Use present tense ("Adds", "Fixes", not "Added", "Fixed")
          PROMPT_END
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' prompt.txt

          # Append the changes
          printf '\n---\n\nCommit messages:\n\n' >> prompt.txt
          cat changes-messages.txt >> prompt.txt
          printf '\n---\n\nDiff summary:\n\n' >> prompt.txt
          cat changes-diff-stat.txt >> prompt.txt
          printf '\n---\n\nFull diffs (may be truncated):\n\n' >> prompt.txt
          cat changes-full.txt >> prompt.txt

          # Call Claude API with file input
          BODY=$(jq -n --rawfile prompt prompt.txt \
            '{
              model: "claude-sonnet-4-6-20250514",
              max_tokens: 2048,
              messages: [{role: "user", content: $prompt}]
            }' | curl -fsSL \
              -X POST "https://api.anthropic.com/v1/messages" \
              -H "content-type: application/json" \
              -H "x-api-key: ${ANTHROPIC_API_KEY}" \
              -H "anthropic-version: 2023-06-01" \
              -d @- | jq -r '.content[0].text')

          if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
            echo "::warning::AI release notes generation failed, falling back to git log"
            BODY=$(git log "$RANGE" --pretty=format:'- %s' --no-merges)
          fi

          printf '%s\n' "$BODY" > release-notes.md
          echo "--- Generated release notes ---"
          cat release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$TAG" release-files/* \
            --repo "$GITHUB_REPOSITORY" \
            --title "Selkie $TAG" \
            --notes-file release-notes.md

  # --- Repository update stage ---
  update-package-repos:
    needs: [prepare, release]
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.prepare.outputs.tag }}
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro createrepo-c rpm

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.SELKIE_GPG_PRIVATE_KEY }}

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      # --- APT repository ---
      - name: Update APT repository
        working-directory: gh-pages
        run: |
          # Remove old versions
          for pkg in $(reprepro -b . list stable | awk '{print $2}' | sort -u); do
            reprepro -b . remove stable "$pkg" || true
          done
          # Add new .deb files
          for deb in ../artifacts/selkie-deb-*/*.deb; do
            reprepro -b . includedeb stable "$deb"
          done

      # --- DNF repository ---
      - name: Update DNF repository
        working-directory: gh-pages
        env:
          GPG_KEY_ID: ${{ steps.import_gpg.outputs.keyid }}
        run: |
          mkdir -p rpm/x86_64 rpm/aarch64
          # Copy RPMs
          for rpm_file in ../artifacts/selkie-rpm-*/*.rpm; do
            if echo "$rpm_file" | grep -q 'x86_64'; then
              cp "$rpm_file" rpm/x86_64/
            elif echo "$rpm_file" | grep -q 'aarch64'; then
              cp "$rpm_file" rpm/aarch64/
            fi
          done
          # Configure RPM macros for non-interactive signing
          printf '%s\n' \
            "%_gpg_name ${GPG_KEY_ID}" \
            '%__gpg_sign_cmd %{__gpg} gpg --batch --yes --no-armor --no-secmem-warning -u "%{_gpg_name}" -sbo %{__signature_filename} %{__plaintext_filename}' \
            > ~/.rpmmacros
          # Sign RPMs
          for rpm_file in rpm/*/*.rpm; do
            rpmsign --addsign "$rpm_file" || true
          done
          # Update repo metadata
          for dir in rpm/x86_64 rpm/aarch64; do
            if [ -d "$dir" ] && ls "$dir"/*.rpm >/dev/null 2>&1; then
              createrepo_c --update "$dir"
              gpg --batch --yes --default-key "$GPG_KEY_ID" --detach-sign --armor "$dir/repodata/repomd.xml"
            fi
          done
          # Generate repo file
          printf '%s\n' \
            '[selkie]' \
            'name=Selkie Markdown Viewer' \
            'baseurl=https://aaddrick.github.io/selkie/rpm/$basearch/' \
            'enabled=1' \
            'gpgcheck=1' \
            'gpgkey=https://aaddrick.github.io/selkie/KEY.gpg' \
            > rpm/selkie.repo

      - name: Commit and push
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update repositories for ${TAG}"
          # Retry push up to 3 times (in case of concurrent updates)
          for i in 1 2 3; do
            git push && break
            echo "Push attempt $i failed, pulling and retrying..."
            git pull --rebase
          done

  # --- AUR update stage ---
  update-aur:
    needs: [prepare, release]
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.prepare.outputs.tag }}
    steps:
      - name: Set up SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          printf '%s\n' \
            'Host aur.archlinux.org' \
            '  IdentityFile ~/.ssh/aur' \
            '  User aur' \
            '  StrictHostKeyChecking accept-new' \
            >> ~/.ssh/config

      - name: Clone AUR repo
        run: git clone ssh://aur@aur.archlinux.org/selkie.git aur-selkie

      - name: Download source tarball and update PKGBUILD
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${TAG#v}"

          # Download source tarball and compute checksum
          curl -fsSL -o source.tar.gz \
            "https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${TAG}.tar.gz"
          SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)

          cd aur-selkie
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${SHA256}')/" PKGBUILD

          # Generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:base \
            bash -c 'pacman -Sy --noconfirm sudo && useradd -m build && \
              echo "build ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
              chown -R build:build /pkg && \
              su - build -c "cd /pkg && makepkg --printsrcinfo" > .SRCINFO'

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${VERSION}"
          git push
